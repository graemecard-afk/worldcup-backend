import { query } from './db.js';

const SCHEMA_SQL = `
-- =========================
-- USERS
-- =========================
CREATE TABLE IF NOT EXISTS users (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  timezone TEXT NOT NULL DEFAULT 'UTC',
  is_admin BOOLEAN DEFAULT FALSE,
  payment_status TEXT DEFAULT 'none'
);


-- =========================
-- TOURNAMENTS
-- =========================
CREATE TABLE IF NOT EXISTS tournaments (
  id UUID PRIMARY KEY,
  name TEXT NOT NULL,
  year INTEGER NOT NULL,
  host_timezone TEXT NOT NULL,
  group_stage_start TIMESTAMPTZ NOT NULL,
  group_stage_end TIMESTAMPTZ NOT NULL,
  knockouts_start TIMESTAMPTZ NOT NULL
);

INSERT INTO tournaments (
  id, name, year, host_timezone, group_stage_start, group_stage_end, knockouts_start
) VALUES (
  '11111111-1111-1111-1111-111111111111',
  'Dummy Cup 2026',
  2026,
  'UTC',
  '2026-06-10 10:00:00+00',
  '2026-06-20 22:00:00+00',
  '2026-06-21 10:00:00+00'
)
ON CONFLICT (id) DO NOTHING;

-- =========================
-- MATCHES
-- =========================
CREATE TABLE IF NOT EXISTS matches (
  id UUID PRIMARY KEY,
  tournament_id UUID NOT NULL REFERENCES tournaments(id),
  stage TEXT NOT NULL,
  group_name TEXT,
  home_team TEXT NOT NULL,
  away_team TEXT NOT NULL,
  kickoff_utc TIMESTAMPTZ NOT NULL,
  venue TEXT,
  result_home_goals INTEGER,
  result_away_goals INTEGER,
  result_finalized BOOLEAN DEFAULT FALSE
);

INSERT INTO matches (
  id, tournament_id, stage, group_name, home_team, away_team, kickoff_utc, venue
) VALUES
  -- Group A
  ('20000000-0000-0000-0000-000000000001','11111111-1111-1111-1111-111111111111','GROUP','Group A','Alpha','Bravo','2026-06-10 12:00:00+00','Stadium 1'),
  ('20000000-0000-0000-0000-000000000002','11111111-1111-1111-1111-111111111111','GROUP','Group A','Charlie','Delta','2026-06-10 15:00:00+00','Stadium 1'),
  ('20000000-0000-0000-0000-000000000005','11111111-1111-1111-1111-111111111111','GROUP','Group A','India','Juliet','2026-06-10 18:00:00+00','Stadium 1'),
  ('20000000-0000-0000-0000-000000000006','11111111-1111-1111-1111-111111111111','GROUP','Group A','Kilo','Lima','2026-06-10 21:00:00+00','Stadium 1'),
  ('20000000-0000-0000-0000-000000000007','11111111-1111-1111-1111-111111111111','GROUP','Group A','Mike','November','2026-06-11 00:00:00+00','Stadium 1'),

  -- Group B
  ('20000000-0000-0000-0000-000000000003','11111111-1111-1111-1111-111111111111','GROUP','Group B','Echo','Foxtrot','2026-06-11 12:00:00+00','Stadium 2'),
  ('20000000-0000-0000-0000-000000000004','11111111-1111-1111-1111-111111111111','GROUP','Group B','Golf','Hotel','2026-06-11 15:00:00+00','Stadium 2'),
  ('20000000-0000-0000-0000-000000000008','11111111-1111-1111-1111-111111111111','GROUP','Group B','Oscar','Papa','2026-06-11 18:00:00+00','Stadium 2'),
  ('20000000-0000-0000-0000-000000000009','11111111-1111-1111-1111-111111111111','GROUP','Group B','Quebec','Romeo','2026-06-11 21:00:00+00','Stadium 2'),
  ('20000000-0000-0000-0000-000000000010','11111111-1111-1111-1111-111111111111','GROUP','Group B','Sierra','Tango','2026-06-12 00:00:00+00','Stadium 2')
ON CONFLICT (id) DO NOTHING;

-- =========================
-- FIX TEAM NAMES + KICKOFFS (DO NOT TOUCH RESULTS)
-- =========================

UPDATE matches
SET
  home_team = CASE id
    WHEN '20000000-0000-0000-0000-000000000001' THEN 'Newcastle United'
    WHEN '20000000-0000-0000-0000-000000000002' THEN 'Bournemouth'
    WHEN '20000000-0000-0000-0000-000000000005' THEN 'Brighton & Hove Albion'
    WHEN '20000000-0000-0000-0000-000000000006' THEN 'Manchester City'
    WHEN '20000000-0000-0000-0000-000000000007' THEN 'Wolverhampton Wanderers'
    WHEN '20000000-0000-0000-0000-000000000003' THEN 'Tottenham Hotspur'
    WHEN '20000000-0000-0000-0000-000000000004' THEN 'Everton'
    WHEN '20000000-0000-0000-0000-000000000008' THEN 'Leeds United'
    WHEN '20000000-0000-0000-0000-000000000009' THEN 'Aston Villa'
    WHEN '20000000-0000-0000-0000-000000000010' THEN 'Fulham'
    ELSE home_team
  END,
  away_team = CASE id
    WHEN '20000000-0000-0000-0000-000000000001' THEN 'Chelsea'
    WHEN '20000000-0000-0000-0000-000000000002' THEN 'Burnley'
    WHEN '20000000-0000-0000-0000-000000000005' THEN 'Sunderland'
    WHEN '20000000-0000-0000-0000-000000000006' THEN 'West Ham United'
    WHEN '20000000-0000-0000-0000-000000000007' THEN 'Brentford'
    WHEN '20000000-0000-0000-0000-000000000003' THEN 'Liverpool'
    WHEN '20000000-0000-0000-0000-000000000004' THEN 'Arsenal'
    WHEN '20000000-0000-0000-0000-000000000008' THEN 'Crystal Palace'
    WHEN '20000000-0000-0000-0000-000000000009' THEN 'Manchester United'
    WHEN '20000000-0000-0000-0000-000000000010' THEN 'Nottingham Forest'
    ELSE away_team
  END,
  kickoff_utc = CASE id
    WHEN '20000000-0000-0000-0000-000000000001' THEN '2025-12-20 12:30:00+00'
    WHEN '20000000-0000-0000-0000-000000000002' THEN '2025-12-20 15:00:00+00'
    WHEN '20000000-0000-0000-0000-000000000005' THEN '2025-12-20 15:00:00+00'
    WHEN '20000000-0000-0000-0000-000000000006' THEN '2025-12-20 15:00:00+00'
    WHEN '20000000-0000-0000-0000-000000000007' THEN '2025-12-20 15:00:00+00'
    WHEN '20000000-0000-0000-0000-000000000003' THEN '2025-12-20 17:30:00+00'
    WHEN '20000000-0000-0000-0000-000000000004' THEN '2025-12-20 20:00:00+00'
    WHEN '20000000-0000-0000-0000-000000000008' THEN '2025-12-20 20:00:00+00'
    WHEN '20000000-0000-0000-0000-000000000009' THEN '2025-12-21 16:30:00+00'
    WHEN '20000000-0000-0000-0000-000000000010' THEN '2025-12-22 20:00:00+00'
    ELSE kickoff_utc
  END
WHERE id IN (
  '20000000-0000-0000-0000-000000000001',
  '20000000-0000-0000-0000-000000000002',
  '20000000-0000-0000-0000-000000000003',
  '20000000-0000-0000-0000-000000000004',
  '20000000-0000-0000-0000-000000000005',
  '20000000-0000-0000-0000-000000000006',
  '20000000-0000-0000-0000-000000000007',
  '20000000-0000-0000-0000-000000000008',
  '20000000-0000-0000-0000-000000000009',
  '20000000-0000-0000-0000-000000000010'
);
`;

export async function ensureSchema() {
  console.log('Ensuring database schema exists...');
  await query(SCHEMA_SQL);
  console.log('Schema ensured.');
}

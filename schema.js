import { query } from './db.js';

const SCHEMA_SQL = `
-- =========================
-- USERS
-- =========================
CREATE TABLE IF NOT EXISTS users (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  timezone TEXT NOT NULL DEFAULT 'UTC',
  is_admin BOOLEAN DEFAULT FALSE,
  payment_status TEXT DEFAULT 'none'
);

-- =========================
-- PREDICTIONS
-- =========================
CREATE TABLE IF NOT EXISTS predictions (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id),
  match_id UUID NOT NULL REFERENCES matches(id),
  predicted_home_goals INTEGER NOT NULL,
  predicted_away_goals INTEGER NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, match_id)
);
ALTER TABLE predictions
ADD COLUMN IF NOT EXISTS updated_at TIMESTAMPTZ DEFAULT NOW();

-- =========================
-- PREDICTION HISTORY
-- =========================
CREATE TABLE IF NOT EXISTS prediction_history (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id),
  match_id UUID NOT NULL REFERENCES matches(id),
  predicted_home_goals INTEGER NOT NULL,
  predicted_away_goals INTEGER NOT NULL,
  changed_at TIMESTAMPTZ DEFAULT NOW()
);





-- =========================
-- TOURNAMENTS
-- =========================
CREATE TABLE IF NOT EXISTS tournaments (
  id UUID PRIMARY KEY,
  name TEXT NOT NULL,
  year INTEGER NOT NULL,
  host_timezone TEXT NOT NULL,
  group_stage_start TIMESTAMPTZ NOT NULL,
  group_stage_end TIMESTAMPTZ NOT NULL,
  knockouts_start TIMESTAMPTZ NOT NULL
);

INSERT INTO tournaments (
  id, name, year, host_timezone, group_stage_start, group_stage_end, knockouts_start
) VALUES (
  '11111111-1111-1111-1111-111111111111',
  'Dummy Cup 2026',
  2026,
  'UTC',
  '2026-06-10 10:00:00+00',
  '2026-06-20 22:00:00+00',
  '2026-06-21 10:00:00+00'
)
ON CONFLICT (id) DO NOTHING;

-- =========================
-- MATCHES
-- =========================
CREATE TABLE IF NOT EXISTS matches (
  id UUID PRIMARY KEY,
  tournament_id UUID NOT NULL REFERENCES tournaments(id),
  stage TEXT NOT NULL,
  group_name TEXT,
  home_team TEXT NOT NULL,
  away_team TEXT NOT NULL,
  kickoff_utc TIMESTAMPTZ NOT NULL,
  venue TEXT,
  result_home_goals INTEGER,
  result_away_goals INTEGER,
  result_finalized BOOLEAN DEFAULT FALSE
);
-- =========================
-- UPDATE MATCHES FOR LIVE WEEKEND FIXTURES (SAFE)
-- =========================

UPDATE matches
SET
  home_team = CASE id
    WHEN '20000000-0000-0000-0000-000000000001' THEN 'West Ham'
    WHEN '20000000-0000-0000-0000-000000000002' THEN 'Burnley'
    WHEN '20000000-0000-0000-0000-000000000005' THEN 'Fulham'
    WHEN '20000000-0000-0000-0000-000000000006' THEN 'Manchester City'
    WHEN '20000000-0000-0000-0000-000000000007' THEN 'AFC Bournemouth'
    WHEN '20000000-0000-0000-0000-000000000003' THEN 'Brentford'
    WHEN '20000000-0000-0000-0000-000000000004' THEN 'Crystal Palace'
    WHEN '20000000-0000-0000-0000-000000000008' THEN 'Newcastle'
    WHEN '20000000-0000-0000-0000-000000000009' THEN 'Arsenal'
    WHEN '20000000-0000-0000-0000-000000000010' THEN 'Everton'
    ELSE home_team
  END,
  away_team = CASE id
    WHEN '20000000-0000-0000-0000-000000000001' THEN 'Sunderland'
    WHEN '20000000-0000-0000-0000-000000000002' THEN 'Spurs'
    WHEN '20000000-0000-0000-0000-000000000005' THEN 'Brighton'
    WHEN '20000000-0000-0000-0000-000000000006' THEN 'Wolves'
    WHEN '20000000-0000-0000-0000-000000000007' THEN 'Liverpool'
    WHEN '20000000-0000-0000-0000-000000000003' THEN 'Nottingham Forest'
    WHEN '20000000-0000-0000-0000-000000000004' THEN 'Chelsea'
    WHEN '20000000-0000-0000-0000-000000000008' THEN 'Aston Villa'
    WHEN '20000000-0000-0000-0000-000000000009' THEN 'Manchester United'
    WHEN '20000000-0000-0000-0000-000000000010' THEN 'Leeds'
    ELSE away_team
  END,
  kickoff_utc = CASE id
    WHEN '20000000-0000-0000-0000-000000000001' THEN '2026-01-24 12:30:00+00'
    WHEN '20000000-0000-0000-0000-000000000002' THEN '2026-01-24 15:00:00+00'
    WHEN '20000000-0000-0000-0000-000000000005' THEN '2026-01-24 15:00:00+00'
    WHEN '20000000-0000-0000-0000-000000000006' THEN '2026-01-24 15:00:00+00'
    WHEN '20000000-0000-0000-0000-000000000007' THEN '2026-01-24 17:30:00+00'
    WHEN '20000000-0000-0000-0000-000000000003' THEN '2026-01-25 14:00:00+00'
    WHEN '20000000-0000-0000-0000-000000000004' THEN '2026-01-25 14:00:00+00'
    WHEN '20000000-0000-0000-0000-000000000008' THEN '2026-01-25 14:00:00+00'
    WHEN '20000000-0000-0000-0000-000000000009' THEN '2026-01-25 16:30:00+00'
    WHEN '20000000-0000-0000-0000-000000000010' THEN '2026-01-26 20:00:00+00'
    ELSE kickoff_utc
  END,
  group_name = CASE id
    WHEN '20000000-0000-0000-0000-000000000001' THEN 'Group A'
    WHEN '20000000-0000-0000-0000-000000000002' THEN 'Group A'
    WHEN '20000000-0000-0000-0000-000000000005' THEN 'Group A'
    WHEN '20000000-0000-0000-0000-000000000006' THEN 'Group A'
    WHEN '20000000-0000-0000-0000-000000000007' THEN 'Group A'
    ELSE 'Group B'
  END
WHERE id IN (
  '20000000-0000-0000-0000-000000000001',
  '20000000-0000-0000-0000-000000000002',
  '20000000-0000-0000-0000-000000000003',
  '20000000-0000-0000-0000-000000000004',
  '20000000-0000-0000-0000-000000000005',
  '20000000-0000-0000-0000-000000000006',
  '20000000-0000-0000-0000-000000000007',
  '20000000-0000-0000-0000-000000000008',
  '20000000-0000-0000-0000-000000000009',
  '20000000-0000-0000-0000-000000000010'
);
`;

export async function ensureSchema() {
  console.log('Ensuring database schema exists...');
  await query(SCHEMA_SQL);
  console.log('Schema ensured.');
}
